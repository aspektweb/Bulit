<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Onlayn So'rovnoma — Demo</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="brand">Onlayn So'rovnoma</h1>
      <p class="tagline">Sizning fikringiz muhim — qisqa so'rovnoma to'ldiring.</p>
    </div>
  </header>

  <main class="container main-grid">
    <section id="survey-section" class="card">
      <h2>So'rovnoma</h2>
      <div id="survey-root">
        <p class="muted">Yuklanmoqda...</p>
      </div>
    </section>

    <aside id="results-section" class="card">
      <h3>Natijalar</h3>
      <div id="results-root">
        </**
 * server.js
 * Simple Express server that serves a static frontend and provides API endpoints
 * for a survey: GET /api/questions, POST /api/submit, GET /api/results
 *
 * Database: SQLite (file: survey.db)
 *
 * Usage:
 *   npm install
 *   node server.js
 *
 * Server listens on port 3000 by default.
 */

const express = require('express');
const path = require('path');
const bodyParser = require('body-parser');
const sqlite3 = require('sqlite3').verbose();
const fs = require('fs');

// --- Config ---
const PORT = process.env.PORT || 3000;
const DB_FILE = path.join(__dirname, 'survey.db');

// --- Create app ---
const app = express();
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, 'public')));

// --- Initialize DB ---
let dbExists = fs.existsSync(DB_FILE);
const db = new sqlite3.Database(DB_FILE, (err) => {
  if (err) {
    console.error('DB open error:', err);
    process.exit(1);
  }
});
if (!dbExists) {
  // Create tables if DB file didn't exist
  db.serialize(() => {
    db.run(`
      CREATE TABLE questions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        key_text TEXT NOT NULL UNIQUE,
        label TEXT NOT NULL,
        type TEXT NOT NULL,
        required INTEGER NOT NULL DEFAULT 1,
        meta TEXT
      );
    `);
    db.run(`
      CREATE TABLE responses (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        created_at TEXT NOT NULL,
        answers_json TEXT NOT NULL
      );
    `);
    // Insert default questions
    const stmt = db.prepare(`
      INSERT INTO questions (key_text, label, type, required, meta)
      VALUES (?, ?, ?, ?, ?)
    `);

    // A sample survey with various input types
    stmt.run('name', 'Ismingiz', 'text', 1, JSON.stringify({placeholder: 'Ism familya'}));
    stmt.run('age', 'Yoshingiz', 'number', 1, JSON.stringify({min: 10, max: 120}));
    stmt.run('gender', 'Jinsingiz', 'radio', 1, JSON.stringify({options: ['Erkak', 'Ayol', 'Boshqa', 'Javob bermoqchi emas']}));
    stmt.run('education', 'Ta\'lim darajangiz', 'select', 1, JSON.stringify({options: ['Maktab', 'Oliy', 'Kasb-hunar', 'Boshqa']}));
    stmt.run('satisfaction', 'Xizmatimizdan qancha mamnunsiz?', 'range', 1, JSON.stringify({min: 0, max: 10}));
    stmt.run('features', 'Qaysi funksiyalar sizga yoqdi? (bir nechta tanlash mumkin)', 'checkbox', 0, JSON.stringify({options: ['Tezkor', 'Foydalanish oson', 'Dizayn', 'Ishonchlilik']}));
    stmt.run('improvements', 'Taklif yoki izohlar', 'textarea', 0, JSON.stringify({placeholder: 'Bu yerga yozing...'}));
    stmt.run('email', 'Elektron pochta (ixtiyoriy)', 'email', 0, JSON.stringify({placeholder: 'you@example.com'}));
    stmt.finalize();
    console.log('Database initialized with sample questions.');
  });
}

function getQuestionsFromDB() {
  return new Promise((resolve, reject) => {
    db.all(`SELECT id, key_text AS key, label, type, required, meta FROM questions ORDER BY id ASC`, [], (err, rows) => {
      if (err) return reject(err);
      const qs = rows.map(r => {
        let meta = {};
        try { meta = JSON.parse(r.meta || '{}'); } catch(e) { meta = {}; }
        return {
          id: r.id,
          key: r.key,
          label: r.label,
          type: r.type,
          required: !!r.required,
          meta
        };
      });
      resolve(qs);
    });
  });
}

// --- API: Get questions ---
app.get('/api/questions', async (req, res) => {
  try {
    const qs = await getQuestionsFromDB();
    res.json({ ok: true, questions: qs });
  } catch (err) {
    console.error('GET /api/questions error', err);
    res.status(500).json({ ok: false, error: 'Server error' });
  }
});

// --- API: Submit response ---
app.post('/api/submit', async (req, res) => {
  try {
    const answers = req.body.answers;
    if (!answers || typeof answers !== 'object') {
      return res.status(400).json({ ok: false, error: 'Invalid payload: answers expected' });
    }

    // Basic server-side validation: required fields
    const questions = await getQuestionsFromDB();
    const missing = [];
    for (const q of questions) {
      if (q.required) {
        if (!(q.key in answers) || answers[q.key] === null || answers[q.key] === '' || (Array.isArray(answers[q.key]) && answers[q.key].length === 0)) {
          missing.push(q.key);
        }
      }
    }
    if (missing.length) {
      return res.status(400).json({ ok: false, error: 'Missing required fields', missing });
    }

    // Save to DB
    const createdAt = new Date().toISOString();
    const stmt = db.prepare(`INSERT INTO responses (created_at, answers_json) VALUES (?, ?)`);
    stmt.run(createdAt, JSON.stringify(answers), function (err) {
      if (err) {
        console.error('DB insert error', err);
        return res.status(500).json({ ok: false, error: 'Failed to save response' });
      }
      res.json({ ok: true, id: this.lastID, created_at: createdAt });
    });
    stmt.finalize();
  } catch (err) {
    console.error('POST /api/submit error', err);
    res.status(500).json({ ok: false, error: 'Server error' });
  }
});

// --- API: Get results (summary) ---
app.get('/api/results', (req, res) => {
  // Returns all responses (capped) and an aggregated summary
  db.all(`SELECT id, created_at, answers_json FROM responses ORDER BY id DESC LIMIT 500`, [], (err, rows) => {
    if (err) {
      console.error('GET /api/results db error', err);
      return res.status(500).json({ ok: false, error: 'DB error' });
    }
    const responses = rows.map(r => {
      try { return { id: r.id, created_at: r.created_at, answers: JSON.parse(r.answers_json) }; }
      catch(e) { return { id: r.id, created_at: r.created_at, answers: {} }; }
    });

    // Simple aggregation for some known keys if present
    const agg = {
      totalResponses: responses.length,
      avgAge: null,
      satisfactionAvg: null,
      genderCounts: {}
    };
    let ageSum = 0, ageCount = 0;
    let satSum = 0, satCount = 0;
    for (const r of responses) {
      const a = r.answers;
      if (a.age && !isNaN(Number(a.age))) { ageSum += Number(a.age); ageCount++; }
      if (a.satisfaction !== undefined && !isNaN(Number(a.satisfaction))) { satSum += Number(a.satisfaction); satCount++; }
      if (a.gender) {
        const g = String(a.gender);
        agg.genderCounts[g] = (agg.genderCounts[g] || 0) + 1;
      }
    }
    if (ageCount) agg.avgAge = +(ageSum / ageCount).toFixed(2);
    if (satCount) agg.satisfactionAvg = +(satSum / satCount).toFixed(2);

    res.json({ ok: true, responses, summary: agg });
  });
});

// --- Serve index.html for any other route (client-side routing safe) ---
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// --- Start server ---
app.listen(PORT, () => {
  console.log(`Survey app listening at http://localhost:${PORT}`);
});